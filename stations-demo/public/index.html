<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carte Stations-Service</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin:0; padding:0; }
  #map { height: 100vh; }
</style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([48.8566, 2.3522], 11);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  const apiUrl = "https://data.economie.gouv.fr/api/explore/v2.1/catalog/datasets/prix-des-carburants-en-france-flux-instantane-v2/records?limit=20";

  fetch(apiUrl)
    .then(res => {
      if (!res.ok) throw new Error("Erreur API : " + res.status);
      return res.json();
    })
    .then(data => {
      if (!data.results) throw new Error("Pas de stations dans la réponse API");

      data.results.forEach(station => {
        const lat = parseFloat(station.latitude) / 100000;  // convertir en degrés
        const lon = parseFloat(station.longitude) / 100000; // convertir en degrés
        const nom = `${station.adresse}, ${station.ville}`;

        // prix est une chaîne JSON, on doit la parser
        let prixSP95 = "non disponible";
        let prixGazole = "non disponible";

        try {
          const prixArray = JSON.parse(station.prix);
          prixArray.forEach(p => {
            if (p["@nom"] === "SP95") prixSP95 = p["@valeur"];
            if (p["@nom"] === "Gazole") prixGazole = p["@valeur"];
          });
        } catch(e) {
          console.warn("Erreur parsing prix pour", nom);
        }

        L.marker([lat, lon])
          .addTo(map)
          .bindPopup(`<b>${nom}</b><br>SP95: ${prixSP95} €/L<br>Gazole: ${prixGazole} €/L`);
      });
    })
    .catch(err => console.error("Erreur fetch :", err));
</script>

</body>
</html>
